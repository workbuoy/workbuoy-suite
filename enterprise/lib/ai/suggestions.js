import path from 'path';import sqlite3 from 'sqlite3';import { topK } from './ranker.js';const DB_PATH=process.env.DB_PATH||path.join(process.cwd(),'db','workbuoy.db');export async function generateSuggestions({tenant_id,surface='portal',goal='lukk saker raskt'}){const db=new sqlite3.Database(DB_PATH);const docs=await new Promise(r=>db.all(`SELECT id,title,content FROM kb_documents WHERE (tenant_id=? OR tenant_id IS NULL) AND active=1`,[tenant_id],(e,rows)=>r(rows||[])));const tickets=await new Promise(r=>db.all(`SELECT id,ext_id,title,status FROM tickets WHERE (tenant_id=? OR tenant_id IS NULL) ORDER BY updated_at DESC LIMIT 5`,[tenant_id],(e,rows)=>r(rows||[])));const baseQ='hvordan hjelpe kunden raskt';const ctx=topK(baseQ,docs,3);const first=tickets.find(t=>t.status==='open')||tickets[0];const suggestions=[];suggestions.push({type:'send_message',title:'Svar kunde med vennlig mal',preview:`Hei! Takk for at du tok kontakt. ${ctx[0]?.content?.slice(0,120)||'Vi kan hjelpe deg i gang på 1-2-3.'}`,editable:{text:true},params:{channel:'email',to:'kunde@eksempel.no',body:`Hei! Takk for at du tok kontakt. ${ctx[0]?.content?.slice(0,160)||'Vi kan hjelpe deg i gang på 1-2-3.'}`}});if(first){suggestions.push({type:'update_status',title:`Sett sak "${first.title}" til Pågår`,preview:`Endrer status fra ${first.status} → in_progress`,editable:{status:true,assignee:true},params:{ticket_id:first.ext_id||String(first.id),status:'in_progress',assignee:'Ola'}});}suggestions.push({type:'create_task',title:'Opprett oppgave: Følg opp kunden i morgen',preview:'Lager en enkel oppgave med frist i morgen',editable:{title:true,due_at:true},params:{title:'Følg opp kunden',due_at:new Date(Date.now()+24*3600*1000).toISOString().slice(0,10)}});return suggestions;}